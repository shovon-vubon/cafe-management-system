<!DOCTYPE html>
<html>
  <head>
    <script defer src="./injectScript.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styleguide.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header>
     <div class="logo"><a href="index.html"><img class="logom" src="img/logo-1.png" /></a></div>
     <div class="nav-bar">
        <div class="buttons">
          <button class="back-button" onclick="window.history.back()"><img class="arrow" src="img/arrow.png" /></button>
          <a href="homepage.html" class="scan-button"><img class="scan" src="img/scan.png" /></a>
          <button class="profile-button" onclick="toggleProfileDropdown()"><img class="user" src="img/user.png" /></button>
        </div>
        <div id="profileDropdown" class="profile-dropdown">
          <div class="dropdown-header">
            <div class="dropdown-user-icon">
              <img class="dropdown-user" src="img/user.png" />
            </div>
            <div class="dropdown-user-info">
              <div class="dropdown-username">Admin12</div>
              <div class="dropdown-email">admin123@gmail.com</div>
            </div>
          </div>
          <button class="logout-button" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <div class="table">
      <img class="burger-frenchfry" src="https://c.animaapp.com/mjqaez8iVXnNBu/img/burger-frenchfry.png" />
      <div class="payment-card"></div>

      <!-- Chart replaces the table map here, centered inside the frame -->
      <div class="all-tables">
        <div class="chart-frame">
          <div class="chart-wrap">
            <canvas id="productChart"></canvas>
          </div>
          <div class="chart-caption"></div>
        </div>
      </div>

      <div class="dashboard-buttons">
        <a href="menu.html" class="div-2">
          <img class="ellipse" src="https://c.animaapp.com/mjqaez8iVXnNBu/img/ellipse-6.png" />
          <div class="text-wrapper-48">Menu</div>
        </a>
        <a href="orders.html" class="div-2">
          <img class="ellipse" src="https://c.animaapp.com/mjqaez8iVXnNBu/img/ellipse-6-1.png" />
          <div class="text-wrapper-49">Orders</div>
        </a>
        <a href="payment.html" class="div-2">
          <img class="ellipse" src="https://c.animaapp.com/mjqaez8iVXnNBu/img/ellipse-6-2.png" />
          <div class="text-wrapper-50">Payment</div>
        </a>
        <a href="table.html" class="div-2">
          <img class="ellipse" src="https://c.animaapp.com/mjqaez8iVXnNBu/img/ellipse-6-3.png" />
          <div class="text-wrapper-51">Tables</div>
        </a>
        <a href="analytics.html" class="div-2">
          <img class="ellipse" src="https://c.animaapp.com/mjqaez8iVXnNBu/img/ellipse-6-4.png" />
          <div class="text-wrapper-52">Analytics</div>
        </a>
      </div>

      <footer class="footer">
        <div class="t-c">
          <div class="group-2">
            <div class="terms-conditions">Terms &amp; Conditions</div>
            <p class="p">Â© . All rights reserved</p>
            <div class="text-wrapper-11">Contact us</div>
          </div>
        </div>
      </footer>
    </div>
  </body>
  <script>
    function toggleProfileDropdown() {
      const dropdown = document.getElementById('profileDropdown');
      dropdown.classList.toggle('active');
    }

    function logout() {
      alert('Logging out...');
    }

    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('profileDropdown');
      const profileButton = document.querySelector('.profile-button');
      if (dropdown && profileButton && !profileButton.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.remove('active');
      }
    });

    // Realtime chart + localStorage integration (keeps same behavior)
    (function() {
      const STORAGE_KEY = 'qrcafe_orders';
      const productChartCtx = document.getElementById('productChart').getContext('2d');

      const defaultProducts = ['Coffee','Fruit Cake','Khichuri','Coke','Samosa','Tehari','Noodles','French Fries'];

      function getOrders() {
        try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch (e) { return []; }
      }

      function aggregateByProduct(orders) {
        const counts = {};
        orders.forEach(o => {
          if (!o.items) return;
          o.items.forEach(it => {
            const name = (it.name || 'Unknown').trim();
            const qty = parseInt(it.qty || 1, 10) || 0;
            counts[name] = (counts[name] || 0) + qty;
          });
        });
        return counts;
      }

      const chart = new Chart(productChartCtx, {
        type: 'bar',
        data: { labels: defaultProducts.slice(), datasets: [{ label: 'Qty', data: defaultProducts.map(()=>0), backgroundColor: ['#4dc9f6','#f67019','#f53794','#537bc4','#9ad0f5','#ffd19a','#c7f59e','#d9b3ff'] }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });

      function updateChartFromStorage() {
        const orders = getOrders();
        const counts = aggregateByProduct(orders);
        const labelsSet = new Set(defaultProducts);
        Object.keys(counts).forEach(k => labelsSet.add(k));
        const labels = Array.from(labelsSet);
        const data = labels.map(l => counts[l] || 0);
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      }

      window.addEventListener('storage', function(e) {
        if (!e.key) return;
        if (e.key === STORAGE_KEY || e.key === STORAGE_KEY + '_updated_at') updateChartFromStorage();
      });

      updateChartFromStorage();
    })();
  </script>
</html>
